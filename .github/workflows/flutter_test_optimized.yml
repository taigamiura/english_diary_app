name: ğŸ§ª Flutter Tests (Optimized)

on:
  push:
    branches:
      - main
      - development
  pull_request:
    branches:
      - main
      - development
      - 'feature/*'
      - 'bug/*'
      - 'hotfix/*'

permissions:
  contents: read
  pull-requests: write

jobs:
  # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã™ã‚‹ã‚¸ãƒ§ãƒ–
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # å„ã‚«ãƒ†ã‚´ãƒªã«å¤‰æ›´ãŒã‚ã£ãŸã‹ã©ã†ã‹
      models-changed: ${{ steps.changes.outputs.models }}
      providers-changed: ${{ steps.changes.outputs.providers }}
      services-changed: ${{ steps.changes.outputs.services }}
      repositories-changed: ${{ steps.changes.outputs.repositories }}
      views-changed: ${{ steps.changes.outputs.views }}
      widgets-changed: ${{ steps.changes.outputs.widgets }}
      utils-changed: ${{ steps.changes.outputs.utils }}
      # ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã‚’æ±ºå®š
      test-strategy: ${{ steps.strategy.outputs.strategy }}
      
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦å¤‰æ›´ã‚’æ¤œå‡º
          
      - name: ğŸ” å¤‰æ›´æ¤œå‡º
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            models:
              - 'lib/models/**'
            providers:
              - 'lib/providers/**'
            services:
              - 'lib/services/**'
            repositories:
              - 'lib/repositories/**'
            views:
              - 'lib/views/**'
            widgets:
              - 'lib/widgets/**'
            utils:
              - 'lib/utils/**'
            config:
              - 'pubspec.yaml'
              - 'pubspec.lock'
              - '.github/workflows/**'
            
      - name: ğŸ¯ ãƒ†ã‚¹ãƒˆæˆ¦ç•¥æ±ºå®š
        id: strategy
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒã«åŸºã¥ã„ãŸæˆ¦ç•¥æ±ºå®š
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "strategy=full" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/development" ]]; then
            echo "strategy=comprehensive" >> $GITHUB_OUTPUT
          elif [[ "${{ github.head_ref }}" == feature/* ]]; then
            echo "strategy=targeted" >> $GITHUB_OUTPUT
          elif [[ "${{ github.head_ref }}" == hotfix/* ]]; then
            echo "strategy=critical" >> $GITHUB_OUTPUT
          else
            echo "strategy=standard" >> $GITHUB_OUTPUT
          fi

  # ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆæœ€å„ªå…ˆï¼‰
  critical-tests:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always() # å¸¸ã«å®Ÿè¡Œ
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        run: flutter pub get
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        run: |
          echo "# Test environment variables" > .env
          echo "API_URL=https://test-api.example.com" >> .env
          echo "DEBUG_MODE=true" >> .env
          echo "Environment file created for testing"
        
      - name: ğŸ§ª ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          # æœ€é‡è¦ãªãƒ¢ãƒ‡ãƒ«ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ãƒ†ã‚¹ãƒˆã®ã¿
          flutter test test/models/ test/utils/ --reporter=compact
          
  # ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ†ã‚¹ãƒˆï¼ˆå¤‰æ›´ã•ã‚ŒãŸéƒ¨åˆ†ã®ã¿ï¼‰
  targeted-tests:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: needs.detect-changes.outputs.test-strategy == 'targeted'
    
    strategy:
      matrix:
        test-category:
          - { name: "models", condition: "${{ needs.detect-changes.outputs.models-changed }}", path: "test/models/" }
          - { name: "providers", condition: "${{ needs.detect-changes.outputs.providers-changed }}", path: "test/providers/" }
          - { name: "services", condition: "${{ needs.detect-changes.outputs.services-changed }}", path: "test/services/" }
          - { name: "repositories", condition: "${{ needs.detect-changes.outputs.repositories-changed }}", path: "test/repositories/" }
          - { name: "views", condition: "${{ needs.detect-changes.outputs.views-changed }}", path: "test/views/" }
          - { name: "widgets", condition: "${{ needs.detect-changes.outputs.widgets-changed }}", path: "test/widgets/" }
          - { name: "utils", condition: "${{ needs.detect-changes.outputs.utils-changed }}", path: "test/utils/" }
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        if: matrix.test-category.condition == 'true'
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        if: matrix.test-category.condition == 'true'
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        if: matrix.test-category.condition == 'true'
        run: flutter pub get
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        if: matrix.test-category.condition == 'true'
        run: |
          echo "# Test environment variables" > .env
          echo "API_URL=https://test-api.example.com" >> .env
          echo "DEBUG_MODE=true" >> .env
          echo "Environment file created for testing"
        
      - name: ğŸ§ª ${{ matrix.test-category.name }} ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        if: matrix.test-category.condition == 'true'
        run: |
          echo "ğŸ¯ ${{ matrix.test-category.name }} ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          if [ -d "${{ matrix.test-category.path }}" ]; then
            flutter test ${{ matrix.test-category.path }} --reporter=expanded
          else
            echo "âš ï¸ ${{ matrix.test-category.path }} ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“"
          fi

  # æ¨™æº–ãƒ†ã‚¹ãƒˆï¼ˆfeature ãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ï¼‰
  standard-tests:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 12
    if: needs.detect-changes.outputs.test-strategy == 'standard'
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        run: flutter pub get
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        run: |
          echo "# Test environment variables" > .env
          echo "API_URL=https://test-api.example.com" >> .env
          echo "DEBUG_MODE=true" >> .env
          echo "Environment file created for testing"
        
      - name: ğŸ§ª æ¨™æº–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ“‹ æ¨™æº–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          # ãƒ¢ãƒ‡ãƒ«ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã¿
          flutter test test/models/ test/services/ test/providers/ --reporter=expanded

  # åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆï¼ˆdevelopment ãƒ–ãƒ©ãƒ³ãƒï¼‰
  comprehensive-tests:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: needs.detect-changes.outputs.test-strategy == 'comprehensive'
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        run: flutter pub get
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        run: |
          echo "# Test environment variables" > .env
          echo "API_URL=https://test-api.example.com" >> .env
          echo "DEBUG_MODE=true" >> .env
          echo "Environment file created for testing"
        
      - name: ğŸ”§ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
        continue-on-error: true
        
      - name: ğŸ§ª åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ” åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          # ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆä»¥å¤–ã®å…¨ãƒ†ã‚¹ãƒˆ
          flutter test --exclude-tags=widget --reporter=expanded --coverage
          
      - name: ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: coverage-report
        run: |
          if [ -f "coverage/lcov.info" ]; then
            echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
            sed -i '/\.g\.dart/d' coverage/lcov.info
            sed -i '/\.freezed\.dart/d' coverage/lcov.info
            echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
            
            # ã‚«ãƒãƒ¬ãƒƒã‚¸çµ±è¨ˆã‚’è¨ˆç®—
            total_lines=$(grep -c "^DA:" coverage/lcov.info || echo "0")
            covered_lines=$(grep "^DA:" coverage/lcov.info | grep -v ",0$" | wc -l || echo "0")
            if [ "$total_lines" -gt 0 ]; then
              coverage_percent=$(echo "scale=2; $covered_lines * 100 / $total_lines" | bc -l)
              echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸: $covered_lines/$total_lines ($coverage_percent%)"
              echo "coverage-percent=$coverage_percent" >> $GITHUB_OUTPUT
              echo "total-lines=$total_lines" >> $GITHUB_OUTPUT
              echo "covered-lines=$covered_lines" >> $GITHUB_OUTPUT
            else
              echo "coverage-percent=0" >> $GITHUB_OUTPUT
              echo "total-lines=0" >> $GITHUB_OUTPUT
              echo "covered-lines=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "coverage-percent=0" >> $GITHUB_OUTPUT
            echo "total-lines=0" >> $GITHUB_OUTPUT
            echo "covered-lines=0" >> $GITHUB_OUTPUT
          fi

  # ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆmain ãƒ–ãƒ©ãƒ³ãƒï¼‰
  full-tests:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: needs.detect-changes.outputs.test-strategy == 'full'
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        run: flutter pub get
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        run: |
          echo "# Test environment variables" > .env
          echo "API_URL=https://test-api.example.com" >> .env
          echo "DEBUG_MODE=true" >> .env
          echo "Environment file created for testing"
        
      - name: ğŸ”§ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
        continue-on-error: true
        
      - name: ğŸ§ª ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ğŸ¯ ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œä¸­..."
          flutter test --reporter=expanded --coverage
          
      - name: ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: coverage-report-full
        run: |
          if [ -f "coverage/lcov.info" ]; then
            echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
            sed -i '/\.g\.dart/d' coverage/lcov.info
            sed -i '/\.freezed\.dart/d' coverage/lcov.info
            echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
            
            # ã‚«ãƒãƒ¬ãƒƒã‚¸çµ±è¨ˆã‚’è¨ˆç®—
            total_lines=$(grep -c "^DA:" coverage/lcov.info || echo "0")
            covered_lines=$(grep "^DA:" coverage/lcov.info | grep -v ",0$" | wc -l || echo "0")
            if [ "$total_lines" -gt 0 ]; then
              coverage_percent=$(echo "scale=2; $covered_lines * 100 / $total_lines" | bc -l)
              echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸: $covered_lines/$total_lines ($coverage_percent%)"
              echo "coverage-percent=$coverage_percent" >> $GITHUB_OUTPUT
              echo "total-lines=$total_lines" >> $GITHUB_OUTPUT  
              echo "covered-lines=$covered_lines" >> $GITHUB_OUTPUT
            else
              echo "coverage-percent=0" >> $GITHUB_OUTPUT
              echo "total-lines=0" >> $GITHUB_OUTPUT
              echo "covered-lines=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "coverage-percent=0" >> $GITHUB_OUTPUT
            echo "total-lines=0" >> $GITHUB_OUTPUT
            echo "covered-lines=0" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’Codecovã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: success()
        uses: codecov/codecov-action@v4
        with:
          file: coverage/lcov.info
          flags: unittests
          name: english-diary-app-coverage
          fail_ci_if_error: false

  # ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
  test-summary:
    needs: [detect-changes, critical-tests, targeted-tests, standard-tests, comprehensive-tests, full-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
        uses: actions/github-script@v7
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
        with:
          script: |
            const strategy = '${{ needs.detect-changes.outputs.test-strategy }}';
            const criticalResult = '${{ needs.critical-tests.result }}';
            const targetedResult = '${{ needs.targeted-tests.result }}';
            const standardResult = '${{ needs.standard-tests.result }}';
            const comprehensiveResult = '${{ needs.comprehensive-tests.result }}';
            const fullResult = '${{ needs.full-tests.result }}';
            
            // ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã‚’å–å¾—
            let coverageInfo = '';
            let coveragePercent = 0;
            
            if (strategy === 'comprehensive' && comprehensiveResult === 'success') {
              // comprehensive-testsã®çµæœã‚’ä½¿ç”¨ï¼ˆoutputså–å¾—ã¯è¤‡é›‘ãªã®ã§ç°¡ç•¥åŒ–ï¼‰
              coverageInfo = 'ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šæ¸ˆã¿ (è©³ç´°ã¯ Actions ãƒ­ã‚°ã‚’å‚ç…§)';
            } else if (strategy === 'full' && fullResult === 'success') {
              // full-testsã®çµæœã‚’ä½¿ç”¨
              coverageInfo = 'ğŸ“Š ãƒ•ãƒ«ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šæ¸ˆã¿ (è©³ç´°ã¯ Actions ãƒ­ã‚°ã‚’å‚ç…§)';
            } else {
              coverageInfo = 'ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šãªã—';
            }
            
            let message = `## ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ\n\n`;
            message += `**å®Ÿè¡Œæˆ¦ç•¥**: ${strategy}\n`;
            message += `**ãƒ–ãƒ©ãƒ³ãƒ**: ${context.ref}\n`;
            message += `**ãƒˆãƒªã‚¬ãƒ¼**: ${context.eventName}\n\n`;
            
            message += `### ğŸ“‹ å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆ\n`;
            message += `- ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ: ${criticalResult === 'success' ? 'âœ…' : criticalResult === 'skipped' ? 'â­ï¸' : 'âŒ'}\n`;
            
            if (strategy === 'targeted') {
              message += `- ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆãƒ†ã‚¹ãƒˆ: ${targetedResult === 'success' ? 'âœ…' : targetedResult === 'skipped' ? 'â­ï¸' : 'âŒ'}\n`;
            } else if (strategy === 'standard') {
              message += `- ğŸ“‹ æ¨™æº–ãƒ†ã‚¹ãƒˆ: ${standardResult === 'success' ? 'âœ…' : standardResult === 'skipped' ? 'â­ï¸' : 'âŒ'}\n`;
            } else if (strategy === 'comprehensive') {
              message += `- ğŸ” åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ: ${comprehensiveResult === 'success' ? 'âœ…' : comprehensiveResult === 'skipped' ? 'â­ï¸' : 'âŒ'}\n`;
            } else if (strategy === 'full') {
              message += `- ğŸ¯ ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆ: ${fullResult === 'success' ? 'âœ…' : fullResult === 'skipped' ? 'â­ï¸' : 'âŒ'}\n`;
            }
            
            // ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±
            message += `\n### ${coverageInfo}\n`;
            
            // main/developmentãƒ–ãƒ©ãƒ³ãƒå‘ã‘PRã®å ´åˆã¯ç‰¹åˆ¥ãªæ³¨æ„æ›¸ã
            if (context.payload.pull_request && 
                (context.payload.pull_request.base.ref === 'main' || 
                 context.payload.pull_request.base.ref === 'development')) {
              message += `\n### âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸è¦ä»¶\n`;
              message += `ã“ã®PRã¯ **${context.payload.pull_request.base.ref}** ãƒ–ãƒ©ãƒ³ãƒã«å‘ã‘ã‚‰ã‚Œã¦ã„ã‚‹ãŸã‚ã€\n`;
              message += `**ã‚«ãƒãƒ¬ãƒƒã‚¸95%ä»¥ä¸Š**ãŒå¿…è¦ã§ã™ã€‚\n\n`;
              
              if (strategy === 'comprehensive' || strategy === 'full') {
                message += `âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒã‚§ãƒƒã‚¯ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚\n`;
                message += `âŒ è¦ä»¶ã‚’æº€ãŸã—ã¦ã„ãªã„å ´åˆã€ãƒãƒ¼ã‚¸ã¯ãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã¾ã™ã€‚\n`;
              } else {
                message += `âš ï¸ ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã§ã¯ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\n`;
                message += `ğŸ“ ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚’æ¨å¥¨ã—ã¾ã™ã€‚\n`;
              }
            }
            
            // å¤‰æ›´æ¤œå‡ºæƒ…å ±
            const changes = [];
            if ('${{ needs.detect-changes.outputs.models-changed }}' === 'true') changes.push('ãƒ¢ãƒ‡ãƒ«');
            if ('${{ needs.detect-changes.outputs.providers-changed }}' === 'true') changes.push('ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼');
            if ('${{ needs.detect-changes.outputs.services-changed }}' === 'true') changes.push('ã‚µãƒ¼ãƒ“ã‚¹');
            if ('${{ needs.detect-changes.outputs.repositories-changed }}' === 'true') changes.push('ãƒªãƒã‚¸ãƒˆãƒª');
            if ('${{ needs.detect-changes.outputs.views-changed }}' === 'true') changes.push('ãƒ“ãƒ¥ãƒ¼');
            if ('${{ needs.detect-changes.outputs.widgets-changed }}' === 'true') changes.push('ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆ');
            if ('${{ needs.detect-changes.outputs.utils-changed }}' === 'true') changes.push('ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£');
            
            if (changes.length > 0) {
              message += `\n### ğŸ”„ æ¤œå‡ºã•ã‚ŒãŸå¤‰æ›´\n`;
              message += changes.map(c => `- ${c}`).join('\n');
            }
            
            // æœ€çµ‚çµæœ
            const allPassed = criticalResult === 'success' && 
              (targetedResult === 'success' || targetedResult === 'skipped') &&
              (standardResult === 'success' || standardResult === 'skipped') &&
              (comprehensiveResult === 'success' || comprehensiveResult === 'skipped') &&
              (fullResult === 'success' || fullResult === 'skipped');
              
            message += `\n### ğŸ‰ ç·åˆçµæœ\n`;
            if (allPassed) {
              message += 'âœ… **ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼**\n\n';
              message += 'ğŸš€ ãƒãƒ¼ã‚¸ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚';
            } else {
              message += 'âŒ **ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ**\n\n';
              message += 'ğŸ”§ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚';
            }
            
            // æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ææ¡ˆ
            message += `\n\n### ğŸ“ æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³\n`;
            if (!allPassed) {
              message += `- âŒ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã®ãƒ­ã‚°ã‚’ç¢ºèª\n`;
              message += `- ğŸ”§ ã‚³ãƒ¼ãƒ‰ã‚’ä¿®æ­£ã—ã¦ãƒ†ã‚¹ãƒˆã‚’é€šã™\n`;
              message += `- ğŸ”„ ä¿®æ­£å¾Œã«å†åº¦ãƒ—ãƒƒã‚·ãƒ¥\n`;
            } else if (strategy === 'targeted' && context.payload.pull_request && 
                       (context.payload.pull_request.base.ref === 'main' || 
                        context.payload.pull_request.base.ref === 'development')) {
              message += `- ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸æ¸¬å®šã®ãŸã‚ã€ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œã‚’æ¤œè¨\n`;
              message += `- âœ… ã™ã¹ã¦å•é¡Œãªã‘ã‚Œã°ãƒ¬ãƒ“ãƒ¥ãƒ¼ä¾é ¼\n`;
            } else {
              message += `- âœ… ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼\n`;
              message += `- ğŸ¯ ãƒãƒ¼ã‚¸ã®æ‰¿èªå¾…ã¡\n`;
            }
            
            if (context.payload.pull_request) {
              try {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: message
                });
                console.log('âœ… ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
              } catch (error) {
                console.log('âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ (æ¨©é™ä¸è¶³ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ã‚¯PR)');
                console.log(`Error: ${error.message}`);
              }
            }
            
            console.log(message);
      - name: ğŸ“‹ ã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°åˆ†æ
        if: always()
        run: |
          echo "ğŸ” ã‚«ãƒãƒ¬ãƒƒã‚¸è©³ç´°åˆ†æã‚’å®Ÿè¡Œä¸­..."
          
          # .envãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªï¼ˆåˆ†ææ™‚ã«ã¯ä¸è¦ã ãŒå®‰å…¨ã®ãŸã‚ï¼‰
          if [ ! -f ".env" ]; then
            echo "âš ï¸ .envãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ä½œæˆã—ã¾ã™"
            echo "API_URL=https://test-api.example.com" > .env
          fi
          
          if [ ! -f "coverage/lcov.info" ]; then
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi
          
          python3 -c "
          import re
          import sys
          
          try:
              with open('coverage/lcov.info', 'r') as f:
                  content = f.read()
              
              if not content.strip():
                  print('âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒç©ºã§ã™')
                  sys.exit(0)
              
              # ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’æŠ½å‡º
              pattern = r'SF:(.*?)\nLF:(\d+)\nLH:(\d+)'
              matches = re.findall(pattern, content, re.DOTALL)
              
              print('ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«åˆ¥ã‚«ãƒãƒ¬ãƒƒã‚¸åˆ†æ:')
              print('=' * 80)
              
              low_coverage_files = []
              high_coverage_files = []
              
              for file_path, lf, lh in matches:
                  lf, lh = int(lf), int(lh)
                  if lf > 0:
                      coverage = (lh / lf) * 100
                      if coverage < 90:
                          low_coverage_files.append((file_path, coverage, lf - lh))
                      elif coverage >= 95:
                          high_coverage_files.append((file_path, coverage))
              
              if low_coverage_files:
                  print('\nâš ï¸  æ”¹å–„ãŒå¿…è¦ãªãƒ•ã‚¡ã‚¤ãƒ« (90%æœªæº€):')
                  print('-' * 60)
                  for file_path, coverage, uncovered in sorted(low_coverage_files, key=lambda x: x[1]):
                      print(f'{file_path:<45} {coverage:>5.1f}% ({uncovered:>2} lines uncovered)')
              
              if high_coverage_files:
                  print('\nâœ… è‰¯å¥½ãªã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ« (95%ä»¥ä¸Š):')
                  print('-' * 60)
                  for file_path, coverage in sorted(high_coverage_files, key=lambda x: x[1], reverse=True)[:10]:
                      print(f'{file_path:<45} {coverage:>5.1f}%')
              
              # æœªã‚«ãƒãƒ¼è¡Œã®è©³ç´°
              print('\nğŸ¯ æœªã‚«ãƒãƒ¼è¡Œã®è©³ç´° (è¡¨ç¤ºåˆ¶é™: å„ãƒ•ã‚¡ã‚¤ãƒ«10è¡Œã¾ã§):')
              print('-' * 80)
              
              current_file = ''
              uncovered_lines = {}
              
              for line in content.split('\n'):
                  if line.startswith('SF:'):
                      current_file = line[3:]
                  elif line.startswith('DA:') and line.endswith(',0'):
                      line_num = line.split(',')[0][3:]
                      if current_file not in uncovered_lines:
                          uncovered_lines[current_file] = []
                      uncovered_lines[current_file].append(line_num)
              
              for file_path, lines in uncovered_lines.items():
                  if len(lines) <= 10:
                      print(f'{file_path}: lines {', '.join(lines)}')
                  else:
                      print(f'{file_path}: {len(lines)} uncovered lines (first 10: {', '.join(lines[:10])}...)')
                      
          except Exception as e:
              print(f'âŒ åˆ†æã‚¨ãƒ©ãƒ¼: {e}')
              sys.exit(0)  # åˆ†æã‚¨ãƒ©ãƒ¼ã¯è‡´å‘½çš„ã§ã¯ãªã„
          "
