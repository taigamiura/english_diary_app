name: ğŸ§ª Flutter Tests (Optimized & Fixed)

on:
  push:
    branches:
      - main
      - development
  pull_request:
    branches:
      - main
      - development
      - 'feature/*'
      - 'bug/*'
      - 'hotfix/*'

permissions:
  contents: read
  pull-requests: write

jobs:
  # å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œå‡ºã™ã‚‹ã‚¸ãƒ§ãƒ–
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      # å„ã‚«ãƒ†ã‚´ãƒªã«å¤‰æ›´ãŒã‚ã£ãŸã‹ã©ã†ã‹
      models-changed: ${{ steps.changes.outputs.models }}
      providers-changed: ${{ steps.changes.outputs.providers }}
      services-changed: ${{ steps.changes.outputs.services }}
      repositories-changed: ${{ steps.changes.outputs.repositories }}
      views-changed: ${{ steps.changes.outputs.views }}
      widgets-changed: ${{ steps.changes.outputs.widgets }}
      utils-changed: ${{ steps.changes.outputs.utils }}
      # ãƒ†ã‚¹ãƒˆæˆ¦ç•¥ã‚’æ±ºå®š
      test-strategy: ${{ steps.strategy.outputs.strategy }}
      
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—ã—ã¦å¤‰æ›´ã‚’æ¤œå‡º
          
      - name: ğŸ” å¤‰æ›´æ¤œå‡º
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            models:
              - 'lib/models/**'
            providers:
              - 'lib/providers/**'
            services:
              - 'lib/services/**'
            repositories:
              - 'lib/repositories/**'
            views:
              - 'lib/views/**'
            widgets:
              - 'lib/widgets/**'
            utils:
              - 'lib/utils/**'
            config:
              - 'pubspec.yaml'
              - 'pubspec.lock'
              - '.github/workflows/**'
            
      - name: ğŸ¯ ãƒ†ã‚¹ãƒˆæˆ¦ç•¥æ±ºå®š
        id: strategy
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒã«åŸºã¥ã„ãŸæˆ¦ç•¥æ±ºå®š
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "strategy=full" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/development" ]]; then
            echo "strategy=comprehensive" >> $GITHUB_OUTPUT
          elif [[ "${{ github.head_ref }}" == feature/* ]]; then
            echo "strategy=targeted" >> $GITHUB_OUTPUT
          elif [[ "${{ github.head_ref }}" == hotfix/* ]]; then
            echo "strategy=critical" >> $GITHUB_OUTPUT
          else
            echo "strategy=standard" >> $GITHUB_OUTPUT
          fi

  # ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆæœ€å„ªå…ˆï¼‰
  critical-tests:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: always() # å¸¸ã«å®Ÿè¡Œ
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        run: flutter pub get
        
      - name: ğŸ§¹ ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™
        run: |
          echo "ğŸ§¹ ãƒ†ã‚¹ãƒˆç’°å¢ƒã‚’æº–å‚™ä¸­..."
          flutter clean
          flutter pub get
          echo "âœ… ç’°å¢ƒæº–å‚™å®Œäº†"
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ (å …ç‰¢ç‰ˆ)
        run: |
          echo "ğŸ“ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­..."
          echo "ğŸ” ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹å†…å®¹ã‚’ç¢ºèª:"
          ls -la | head -20
          echo ""
          echo "ğŸ” .envé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª:"
          ls -la .env* 2>/dev/null || echo "âš ï¸ .envé–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
          echo ""
          
          # .env.exampleãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
          if [ -f ".env.example" ]; then
            echo "âœ… .env.exampleãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã‚³ãƒ”ãƒ¼ã—ã¾ã™..."
            cp .env.example .env
            echo "ğŸ“‹ ä½œæˆã•ã‚ŒãŸ.envãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ï¼ˆå…ˆé ­5è¡Œï¼‰:"
            head -5 .env
          else
            echo "âš ï¸ .env.exampleãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™..."
            echo "# Test Environment Variables for GitHub Actions" > .env
            echo "# This file is automatically generated for CI/CD testing" >> .env
            echo "" >> .env
            echo "# Supabase Configuration (Test)" >> .env
            echo "SUPABASE_URL=https://test-project.supabase.co" >> .env
            echo "SUPABASE_ANON_KEY=test_anon_key_for_ci_testing" >> .env
            echo "" >> .env
            echo "# Sentry Configuration (Test)" >> .env
            echo "SENTRY_DSN=https://test@sentry.io/test-project" >> .env
            echo "" >> .env
            echo "# Google OAuth Configuration (Test)" >> .env
            echo "GOOGLE_IOS_CLIENT_ID=test-ios-client-id.apps.googleusercontent.com" >> .env
            echo "GOOGLE_WEB_CLIENT_ID=test-web-client-id.apps.googleusercontent.com" >> .env
            echo "" >> .env
            echo "# Development User (Test)" >> .env
            echo "DEV_USER_EMAIL=test@example.com" >> .env
            echo "DEV_USER_PASSWORD=test_password_123" >> .env
            echo "" >> .env
            echo "# Additional Settings (Test)" >> .env
            echo "DEBUG_MODE=true" >> .env
            echo "LOG_LEVEL=debug" >> .env
            echo "API_TIMEOUT=30000" >> .env
            echo "ENVIRONMENT=test" >> .env
            echo "âœ… ãƒ†ã‚¹ãƒˆç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
            echo "ğŸ“‹ ä½œæˆã•ã‚ŒãŸ.envãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ï¼ˆå…ˆé ­10è¡Œï¼‰:"
            head -10 .env
          fi
          
          echo ""
          echo "ğŸ“ æœ€çµ‚ç¢ºèª - ä½œæˆã•ã‚ŒãŸ.envãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la .env
          echo "ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(wc -l < .env) è¡Œ"
        
      - name: ğŸ§ª ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        timeout-minutes: 3
        run: |
          echo "ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          # æœ€é‡è¦ãªãƒ¢ãƒ‡ãƒ«ã¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã®ãƒ†ã‚¹ãƒˆã®ã¿
          flutter test test/models/ test/utils/ --reporter=compact --timeout=2m

  # æ¨™æº–ãƒ†ã‚¹ãƒˆï¼ˆfeature ãƒ–ãƒ©ãƒ³ãƒä»¥å¤–ï¼‰
  standard-tests:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 12
    if: needs.detect-changes.outputs.test-strategy == 'standard'
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        run: flutter pub get
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ (æ¨™æº–)
        run: |
          echo "ğŸ“ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­..."
          if [ -f ".env.example" ]; then
            echo "âœ… .env.exampleã‹ã‚‰.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™"
            cp .env.example .env
          else
            echo "âš ï¸ .env.exampleãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ¨™æº–ãƒ†ã‚¹ãƒˆç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™"
            echo "# Standard Test Environment Variables" > .env
            echo "SUPABASE_URL=https://test-project.supabase.co" >> .env
            echo "SUPABASE_ANON_KEY=test_anon_key_for_standard_tests" >> .env
            echo "DEBUG_MODE=true" >> .env
            echo "ENVIRONMENT=standard_test" >> .env
          fi
          echo "âœ… .envãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆå®Œäº†"
        
      - name: ğŸ§ª æ¨™æº–ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        timeout-minutes: 10
        run: |
          echo "ğŸ“‹ æ¨™æº–ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          # ãƒ¢ãƒ‡ãƒ«ã€ã‚µãƒ¼ãƒ“ã‚¹ã€ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã®ã¿
          flutter test test/models/ test/services/ test/providers/ --reporter=expanded --timeout=8m

  # åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆï¼ˆdevelopment ãƒ–ãƒ©ãƒ³ãƒï¼‰
  comprehensive-tests:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: needs.detect-changes.outputs.test-strategy == 'comprehensive'
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        run: flutter pub get
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ (åŒ…æ‹¬çš„)
        run: |
          echo "ğŸ“ åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­..."
          if [ -f ".env.example" ]; then
            cp .env.example .env
            echo "âœ… .env.exampleã‹ã‚‰.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ .env.exampleãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™"
            echo "# Comprehensive Test Environment Variables" > .env
            echo "SUPABASE_URL=https://test-project.supabase.co" >> .env
            echo "SUPABASE_ANON_KEY=test_anon_key_for_comprehensive_tests" >> .env
            echo "SENTRY_DSN=https://test@sentry.io/comprehensive-test" >> .env
            echo "DEBUG_MODE=true" >> .env
            echo "LOG_LEVEL=info" >> .env
            echo "ENVIRONMENT=comprehensive_test" >> .env
          fi
        
      - name: ğŸ”§ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
        continue-on-error: true
        
      - name: ğŸ§ª åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        timeout-minutes: 12
        run: |
          echo "ğŸ” åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œä¸­..."
          # ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆä»¥å¤–ã®å…¨ãƒ†ã‚¹ãƒˆ
          flutter test --exclude-tags=widget --reporter=expanded --coverage --timeout=10m
          
      - name: ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: coverage-report
        run: |
          if [ -f "coverage/lcov.info" ]; then
            echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
            sed -i '/\.g\.dart/d' coverage/lcov.info
            sed -i '/\.freezed\.dart/d' coverage/lcov.info
            echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
            
            # ã‚«ãƒãƒ¬ãƒƒã‚¸çµ±è¨ˆã‚’è¨ˆç®—
            total_lines=$(grep -c "^DA:" coverage/lcov.info || echo "0")
            covered_lines=$(grep "^DA:" coverage/lcov.info | grep -v ",0$" | wc -l || echo "0")
            if [ "$total_lines" -gt 0 ]; then
              coverage_percent=$(echo "scale=2; $covered_lines * 100 / $total_lines" | bc -l)
              echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸: $covered_lines/$total_lines ($coverage_percent%)"
              echo "coverage-percent=$coverage_percent" >> $GITHUB_OUTPUT
              echo "total-lines=$total_lines" >> $GITHUB_OUTPUT
              echo "covered-lines=$covered_lines" >> $GITHUB_OUTPUT
            else
              echo "coverage-percent=0" >> $GITHUB_OUTPUT
              echo "total-lines=0" >> $GITHUB_OUTPUT
              echo "covered-lines=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "coverage-percent=0" >> $GITHUB_OUTPUT
            echo "total-lines=0" >> $GITHUB_OUTPUT
            echo "covered-lines=0" >> $GITHUB_OUTPUT
          fi

  # ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆï¼ˆmain ãƒ–ãƒ©ãƒ³ãƒï¼‰
  full-tests:
    needs: detect-changes
    runs-on: ubuntu-latest
    timeout-minutes: 20
    if: needs.detect-changes.outputs.test-strategy == 'full'
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        run: flutter pub get
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ (ãƒ•ãƒ«)
        run: |
          echo "ğŸ“ ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­..."
          if [ -f ".env.example" ]; then
            cp .env.example .env
            echo "âœ… .env.exampleã‹ã‚‰.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ .env.exampleãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™"
            echo "# Full Test Environment Variables" > .env
            echo "SUPABASE_URL=https://test-project.supabase.co" >> .env
            echo "SUPABASE_ANON_KEY=test_anon_key_for_full_tests" >> .env
            echo "SENTRY_DSN=https://test@sentry.io/full-test" >> .env
            echo "GOOGLE_IOS_CLIENT_ID=test-ios-full.apps.googleusercontent.com" >> .env
            echo "GOOGLE_WEB_CLIENT_ID=test-web-full.apps.googleusercontent.com" >> .env
            echo "DEV_USER_EMAIL=test@example.com" >> .env
            echo "DEV_USER_PASSWORD=test_password_full" >> .env
            echo "DEBUG_MODE=true" >> .env
            echo "LOG_LEVEL=debug" >> .env
            echo "API_TIMEOUT=30000" >> .env
            echo "ENVIRONMENT=full_test" >> .env
          fi
        
      - name: ğŸ”§ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
        continue-on-error: true
        
      - name: ğŸ§ª ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        timeout-minutes: 18
        run: |
          echo "ğŸ¯ ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã‚’å®Ÿè¡Œä¸­..."
          flutter test --reporter=expanded --coverage --timeout=15m
          
      - name: ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        id: coverage-report-full
        run: |
          if [ -f "coverage/lcov.info" ]; then
            echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­..."
            sed -i '/\.g\.dart/d' coverage/lcov.info
            sed -i '/\.freezed\.dart/d' coverage/lcov.info
            echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
            
            # ã‚«ãƒãƒ¬ãƒƒã‚¸çµ±è¨ˆã‚’è¨ˆç®—
            total_lines=$(grep -c "^DA:" coverage/lcov.info || echo "0")
            covered_lines=$(grep "^DA:" coverage/lcov.info | grep -v ",0$" | wc -l || echo "0")
            if [ "$total_lines" -gt 0 ]; then
              coverage_percent=$(echo "scale=2; $covered_lines * 100 / $total_lines" | bc -l)
              echo "ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸: $covered_lines/$total_lines ($coverage_percent%)"
              echo "coverage-percent=$coverage_percent" >> $GITHUB_OUTPUT
              echo "total-lines=$total_lines" >> $GITHUB_OUTPUT  
              echo "covered-lines=$covered_lines" >> $GITHUB_OUTPUT
            else
              echo "coverage-percent=0" >> $GITHUB_OUTPUT
              echo "total-lines=0" >> $GITHUB_OUTPUT
              echo "covered-lines=0" >> $GITHUB_OUTPUT
            fi
          else
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
            echo "coverage-percent=0" >> $GITHUB_OUTPUT
            echo "total-lines=0" >> $GITHUB_OUTPUT
            echo "covered-lines=0" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’Codecovã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: success()
        uses: codecov/codecov-action@v4
        with:
          file: coverage/lcov.info
          flags: unittests
          name: english-diary-app-coverage
          fail_ci_if_error: false

  # ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
  test-summary:
    needs: [detect-changes, critical-tests, standard-tests, comprehensive-tests, full-tests]
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
        uses: actions/github-script@v7
        if: github.event_name == 'push' || github.event.pull_request.head.repo.full_name == github.repository
        with:
          script: |
            const strategy = '${{ needs.detect-changes.outputs.test-strategy }}';
            const criticalResult = '${{ needs.critical-tests.result }}';
            const standardResult = '${{ needs.standard-tests.result }}';
            const comprehensiveResult = '${{ needs.comprehensive-tests.result }}';
            const fullResult = '${{ needs.full-tests.result }}';
            
            let message = `## ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ (æ”¹å–„ç‰ˆ)\n\n`;
            message += `**å®Ÿè¡Œæˆ¦ç•¥**: ${strategy}\n`;
            message += `**ãƒ–ãƒ©ãƒ³ãƒ**: ${context.ref}\n`;
            message += `**ãƒˆãƒªã‚¬ãƒ¼**: ${context.eventName}\n\n`;
            
            message += `### ğŸ“‹ å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆ\n`;
            const criticalStatus = criticalResult === 'success' ? 'âœ…' : 
              criticalResult === 'skipped' ? 'â­ï¸' : 'âŒ';
            message += `- ğŸš¨ ã‚¯ãƒªãƒ†ã‚£ã‚«ãƒ«ãƒ†ã‚¹ãƒˆ: ${criticalStatus}\n`;
            
            if (strategy === 'standard') {
              const standardStatus = standardResult === 'success' ? 'âœ…' : 
                standardResult === 'skipped' ? 'â­ï¸' : 'âŒ';
              message += `- ğŸ“‹ æ¨™æº–ãƒ†ã‚¹ãƒˆ: ${standardStatus}\n`;
            } else if (strategy === 'comprehensive') {
              const comprehensiveStatus = comprehensiveResult === 'success' ? 'âœ…' : 
                comprehensiveResult === 'skipped' ? 'â­ï¸' : 'âŒ';
              message += `- ğŸ” åŒ…æ‹¬çš„ãƒ†ã‚¹ãƒˆ: ${comprehensiveStatus}\n`;
            } else if (strategy === 'full') {
              const fullStatus = fullResult === 'success' ? 'âœ…' : 
                fullResult === 'skipped' ? 'â­ï¸' : 'âŒ';
              message += `- ğŸ¯ ãƒ•ãƒ«ãƒ†ã‚¹ãƒˆ: ${fullStatus}\n`;
            }
            
            // æœ€çµ‚çµæœ
            const allPassed = criticalResult === 'success' && 
              (standardResult === 'success' || standardResult === 'skipped') &&
              (comprehensiveResult === 'success' || comprehensiveResult === 'skipped') &&
              (fullResult === 'success' || fullResult === 'skipped');
              
            message += `\n### ğŸ‰ ç·åˆçµæœ\n`;
            if (allPassed) {
              message += 'âœ… **ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸï¼**\n\n';
              message += 'ğŸš€ ãƒãƒ¼ã‚¸ã®æº–å‚™ãŒã§ãã¦ã„ã¾ã™ã€‚';
            } else {
              message += 'âŒ **ä¸€éƒ¨ã®ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ**\n\n';
              message += 'ğŸ”§ å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚’ä¿®æ­£ã—ã¦ã‹ã‚‰å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¦ãã ã•ã„ã€‚';
            }
            
            if (context.payload.pull_request) {
              try {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: message
                });
                console.log('âœ… ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
              } catch (error) {
                console.log('âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ (æ¨©é™ä¸è¶³ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ã‚¯PR)');
                console.log(`Error: ${error.message}`);
              }
            }
            
            console.log(message);
