name: ğŸ¤– Auto Merge Dependabot PRs

on:
  pull_request:
    types:
      - labeled
      - opened
      - synchronize
      - ready_for_review
    branches:
      - main
      - develop

jobs:
  automerge:
    if: |
      github.actor == 'dependabot[bot]' || github.actor == 'dependabot-preview[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ” Get PR metadata
        id: pr-metadata
        run: |
          echo "pr-title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
          echo "pr-labels=${{ join(github.event.pull_request.labels.*.name, ',') }}" >> $GITHUB_OUTPUT

      - name: ğŸš¨ Check for security updates
        id: security-check
        run: |
          if [[ "${{ steps.pr-metadata.outputs.pr-title }}" =~ (security|vulnerability|CVE) ]] || \
             [[ "${{ steps.pr-metadata.outputs.pr-labels }}" =~ security ]]; then
            echo "is-security=true" >> $GITHUB_OUTPUT
            echo "ğŸš¨ Security update detected"
          else
            echo "is-security=false" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ Regular dependency update"
          fi

      - name: ğŸ”„ Enable auto-merge for Dependabot PR
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          merge-method: squash
          pull-request-number: ${{ github.event.pull_request.number }}

      - name: ğŸ·ï¸ Add priority label for security updates
        if: steps.security-check.outputs.is-security == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['priority: high', 'security']
            });

      - name: ğŸ’¬ Comment on security PR
        if: steps.security-check.outputs.is-security == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ğŸš¨ **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆæ¤œå‡º** \n\nã“ã®PRã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é–¢é€£ã®ä¾å­˜é–¢ä¿‚æ›´æ–°ã‚’å«ã‚“ã§ã„ã¾ã™ã€‚ãƒ†ã‚¹ãƒˆãŒé€šéæ¬¡ç¬¬ã€è‡ªå‹•çš„ã«ãƒãƒ¼ã‚¸ã•ã‚Œã¾ã™ã€‚'
            });
