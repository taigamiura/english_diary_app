name: ğŸ§ª Flutter Tests

on:
  push:
    branches:
      - main
      - development
  pull_request:
    branches:
      - main
      - development
      - 'feature/*'
      - 'bug/*'

permissions:
  contents: write
  pull-requests: write

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: ğŸ“‚ ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4
        
      - name: ğŸ¦ Flutter ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ vars.FLUTTER_VERSION || '3.24.3' }}
          channel: 'stable'
          cache: true
          
      - name: ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®å–å¾—
        run: flutter pub get
        
      - name: ğŸ”§ .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
        run: |
          echo "ğŸ“ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆä¸­..."
          
          # .env.exampleãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯ãã‚Œã‚’ä½¿ç”¨
          if [ -f ".env.example" ]; then
            echo "âœ… .env.exampleãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ã‚³ãƒ”ãƒ¼ã—ã¾ã™..."
            cp .env.example .env
            echo "ğŸ“‹ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
          else
            echo "âš ï¸ .env.exampleãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã™..."
            echo "# Test Environment Variables for GitHub Actions" > .env
            echo "# This file is automatically generated for CI/CD testing" >> .env
            echo "" >> .env
            echo "# Supabase Configuration (Test)" >> .env
            echo "SUPABASE_URL=https://test-project.supabase.co" >> .env
            echo "SUPABASE_ANON_KEY=test_anon_key_for_ci_testing" >> .env
            echo "" >> .env
            echo "# Sentry Configuration (Test)" >> .env
            echo "SENTRY_DSN=https://test@sentry.io/test-project" >> .env
            echo "" >> .env
            echo "# Google OAuth Configuration (Test)" >> .env
            echo "GOOGLE_IOS_CLIENT_ID=test-ios.apps.googleusercontent.com" >> .env
            echo "GOOGLE_WEB_CLIENT_ID=test-web.apps.googleusercontent.com" >> .env
            echo "" >> .env
            echo "# Development User (Test)" >> .env
            echo "DEV_USER_EMAIL=test@example.com" >> .env
            echo "DEV_USER_PASSWORD=test_password_123" >> .env
            echo "" >> .env
            echo "# Additional Settings (Test)" >> .env
            echo "DEBUG_MODE=true" >> .env
            echo "LOG_LEVEL=debug" >> .env
            echo "API_TIMEOUT=30000" >> .env
            echo "ENVIRONMENT=test" >> .env
            echo "âœ… ãƒ†ã‚¹ãƒˆç”¨.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œæˆã—ã¾ã—ãŸ"
            echo "ğŸ“‹ ä½œæˆã•ã‚ŒãŸ.envãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ï¼ˆå…ˆé ­10è¡Œï¼‰:"
            head -10 .env
          fi
          
          echo "ğŸ“ ç¢ºèª - ä½œæˆã•ã‚ŒãŸ.envãƒ•ã‚¡ã‚¤ãƒ«:"
          ls -la .env 2>/dev/null || echo "âŒ .envãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã«å¤±æ•—"
        
      - name: ğŸ”§ ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        run: flutter packages pub run build_runner build --delete-conflicting-outputs
        continue-on-error: true
        
      - name: ğŸ§ª å˜ä½“ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        env:
          CI: true
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}
        run: |
          echo "ğŸ“‹ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’é–‹å§‹ã—ã¾ã™..."
          flutter test --reporter=expanded --coverage
          
      - name: ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
        run: |
          # ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿å‡¦ç†
          if [ -f "coverage/lcov.info" ]; then
            echo "ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆä¸­..."
            # Remove generated files from coverage
            sed -i '/\.g\.dart/d' coverage/lcov.info
            sed -i '/\.freezed\.dart/d' coverage/lcov.info
            echo "âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†"
          else
            echo "âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi
          
      - name: ğŸ“ˆ ã‚«ãƒãƒ¬ãƒƒã‚¸ã‚’Codecovã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: success()
        uses: codecov/codecov-action@v4
        with:
          file: coverage/lcov.info
          flags: unittests
          name: english-diary-app-coverage
          token: ${{ secrets.CODECOV_TOKEN }}
          fail_ci_if_error: false
          
      - name: ğŸ’¬ ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚³ãƒ¡ãƒ³ãƒˆï¼ˆPRæ™‚ï¼‰
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let coverageInfo = '';
            
            try {
              if (fs.existsSync('coverage/lcov.info')) {
                coverageInfo = 'âœ… ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸ';
              } else {
                coverageInfo = 'âš ï¸ ã‚«ãƒãƒ¬ãƒƒã‚¸ãƒ¬ãƒãƒ¼ãƒˆã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ';
              }
            } catch (error) {
              coverageInfo = 'âŒ ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
            }
            
            const message = `## ğŸ§ª ãƒ†ã‚¹ãƒˆå®Ÿè¡Œçµæœ
            
            âœ… ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼
            
            ### ğŸ“Š ã‚«ãƒãƒ¬ãƒƒã‚¸æƒ…å ±
            ${coverageInfo}
            
            ### ğŸ” å®Ÿè¡Œã•ã‚ŒãŸãƒ†ã‚¹ãƒˆã‚«ãƒ†ã‚´ãƒª
            - âœ… ãƒ¢ãƒ‡ãƒ«ãƒ†ã‚¹ãƒˆ
            - âœ… ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ãƒ†ã‚¹ãƒˆ  
            - âœ… ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ãƒ†ã‚¹ãƒˆ
            - âœ… ã‚¦ã‚£ã‚¸ã‚§ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
            
            ğŸ‰ ã‚³ãƒ¼ãƒ‰ã®å“è³ªãŒç¶­æŒã•ã‚Œã¦ã„ã¾ã™ï¼`;
            
            try {
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: message
              });
              console.log('âœ… ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
            } catch (error) {
              console.log('âš ï¸ ã‚³ãƒ¡ãƒ³ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ (æ¨©é™ä¸è¶³ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ã‚¯PR)');
              console.log(`Error: ${error.message}`);
            }
            
      - name: âŒ ãƒ†ã‚¹ãƒˆå¤±æ•—æ™‚ã®è©³ç´°å ±å‘Š
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `## âŒ ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¤±æ•—ã—ã¾ã—ãŸ
            
            ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚
            
            ### ğŸ”§ å¯¾å‡¦æ–¹æ³•
            1. ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ \`flutter test\` ã‚’å®Ÿè¡Œã—ã¦ã‚¨ãƒ©ãƒ¼ã‚’ç¢ºèª
            2. ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£
            3. å¿…è¦ã«å¿œã˜ã¦ä¾å­˜é–¢ä¿‚ã®æ›´æ–°
            
            ### ğŸ“‹ ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ
            - [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒãƒ­ãƒ¼ã‚«ãƒ«ã§é€šéã™ã‚‹ã“ã¨ã‚’ç¢ºèª
            - [ ] æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã«å¯¾å¿œã™ã‚‹ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ 
            - [ ] ãƒ¢ãƒƒã‚¯ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
            
            è©³ç´°ã¯Actions ã®ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`;
            
            if (context.payload.pull_request) {
              try {
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: message
                });
                console.log('âœ… ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã—ãŸ');
              } catch (error) {
                console.log('âš ï¸ ã‚¨ãƒ©ãƒ¼ãƒ¬ãƒãƒ¼ãƒˆæŠ•ç¨¿ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã—ãŸ (æ¨©é™ä¸è¶³ã¾ãŸã¯ãƒ•ã‚©ãƒ¼ã‚¯PR)');
                console.log(`Error: ${error.message}`);
              }
            }
